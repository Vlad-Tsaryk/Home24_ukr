{% extends 'layout/basic.html' %}
{% load static %}
{% block head %}
    <link rel="stylesheet" type="text/css"
          href="{% static 'admin_panel/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css' %}"/>
{% endblock %}
{% block header_text %}
    Пользователи
{% endblock %}
{% block breadcrumb %}
    <ul class="breadcrumb"><li><a href="{% url 'statistic' %}"><i class="fa fa-home"></i> Главная</a></li>
<li class="active">Пользователи</li>
</ul>
{% endblock %}
{% block content %}
    <div class="row">
        <!--<div class="col-xs-12 col-sm-6">-->
        <!--<h2 class="page-header">Квартиры</h2>-->
        <!--</div>-->
        <div class="col-xs-12">

            <div class="pull-right margin-bottom">
                <a class="btn btn-success" href="{% url 'create_user' %}">Создать пользователя</a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title"></h3>
                    <div class="box-tools">
                        <a onclick="clear_filters()" class="btn btn-default btn-sm">
                            <span class="hidden-xs">Очистить</span><i class="fa fa-eraser visible-xs"
                                                                      aria-hidden="true"></i>
                        </a>
                    </div>
                </div>

                <div class="grid-view">
                    <div class="box-body table-responsive no-padding">
                        <table id="users_table" class="table table-bordered table-hover table-striped linkedRow">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Пользователь</th>
                                <th>Роль</th>
                                <th>Телефон</th>
                                <th>Email (логин)</th>
                                <th>Статус</th>
                                <th style="width: 114px; min-width: 114px">&nbsp;</th>
                            </tr>
                            <tr id="w0-filters" class="filters">
                                <td>&nbsp;</td>
                                <td rowspan="1" colspan="1"><input type="text" class="column_search form-control" id="name"></td>
                                <td><select id="role" class="form-control select2-hidden-accessible column_search"
                                            name="UserAdminSearch[role]" data-s2-options="s2options_7ebc6538"
                                            data-krajee-select2="select2_0d896465" tabindex="-1"
                                            aria-hidden="true" data-index="2">
                                    <option style="background-color: #00a65a;" value=""></option>
                                    <option style="background-color: #00a65a;" value="Директор">Директор</option>
                                    <option style="background-color: #00a65a;" value="Управляющий">Управляющий</option>
                                    <option style="background-color: #00a65a;" value="Бухгалтер">Бухгалтер</option>
                                    <option style="background-color: #00a65a;" value="Электрик">Электрик</option>
                                    <option style="background-color: #00a65a;" value="Сантехник">Сантехник</option>
                                </select></td>
                                <th rowspan="1" colspan="1"><input type="text" class="column_search form-control" id="phone"></th>
                                <th><input type="text" class="form-control column_search" name="UserAdminSearch[email]" id="username"
                                           data-index="4"></th>
                                <th><select id="status" class="form-control select2-hidden-accessible column_search"
                                            name="UserAdminSearch[status]" data-s2-options="s2options_7ebc6538"
                                            data-krajee-select2="select2_0d896465" tabindex="-1"
                                            aria-hidden="true">
                                    <option value=""></option>
                                    <option value="Активен">Активен</option>
                                    <option value="Новый">Новый</option>
                                    <option value="Отключен">Отключен</option>
                                </select></th>
                                <td>&nbsp;</td>
                            </tr>
                            </thead>

                            <tbody>
{#                            <tr data-href="#" data-key="0">#}
{#                                <td>0</td>#}
{#                                <td>{{ admin.first_name }} {{ admin.last_name }}</td>#}
{#                                <td>#}
{#                                    {{ admin.role.role }}</td>#}
{#                                <td>#}
{#                                    {{ admin.phone }}</td>#}
{#                                <td>{{ admin.username }}</td>#}
{#                                <td><small class="label label-success">{{ admin.status }}</small></td>#}
{#                                <td>#}
{#                                    <div class="btn-group pull-right"><a class="btn btn-default btn-sm"#}
{#                                                                         href="/admin/user-admin/invite/1"#}
{#                                                                         title="Отправить приглашение"#}
{#                                                                         data-toggle="tooltip"><i#}
{#                                            class="fa fa-repeat"></i></a> <a class="btn btn-default btn-sm"#}
{#                                                                             href="{% url 'update_user' admin.pk %}"#}
{#                                                                             title="Редактировать"#}
{#                                                                             data-toggle="tooltip"><i#}
{#                                            class="fa fa-pencil"></i></a>#}
{#                                        <button class="btn btn-default btn-sm disabled"><i class="fa fa-trash"></i>#}
{#                                        </button>#}
{#                                    </div>#}
{#                                </td>#}
{#                            </tr>#}
{#                            {% for user in user_list %}#}
{#                                {% if user.is_superuser %}#}
{#                                {% else %}#}
{#                                    <tr data-href="/admin/user-admin/2" data-key="{{ forloop.counter }}">#}
{#                                        <td>{{ forloop.counter }}</td>#}
{#                                        <td>{{ user.first_name }} {{ user.last_name }}</td>#}
{#                                        <td>#}
{#                                            {{ user.role.role }}</td>#}
{#                                        <td>#}
{#                                            {{ user.phone }}</td>#}
{#                                        <td>{{ user.username }}</td>#}
{#                                        <td><small class="label label-success">{{ user.status }}</small></td>#}
{#                                        <td>#}
{#                                            <div class="btn-group pull-right"><a class="btn btn-default btn-sm"#}
{#                                                                                 href="/admin/user-admin/invite/2"#}
{#                                                                                 title="Отправить приглашение"#}
{#                                                                                 data-toggle="tooltip"><i#}
{#                                                    class="fa fa-repeat"></i></a> <a class="btn btn-default btn-sm"#}
{#                                                                                     href="{% url 'update_user' user.pk %}"#}
{#                                                                                     title="Редактировать"#}
{#                                                                                     data-toggle="tooltip"><i#}
{#                                                    class="fa fa-pencil"></i></a> <a class="btn btn-default btn-sm"#}
{#                                                                                     href="/admin/user-admin/delete/2"#}
{#                                                                                     title="Удалить"#}
{#                                                                                     data-toggle="tooltip" data-pjax="0"#}
{#                                                                                     data-method="post"#}
{#                                                                                     data-confirm="Вы уверены, что хотите удалить этот элемент?"><i#}
{#                                                    class="fa fa-trash"></i></a></div>#}
{#                                        </td>#}
{#                                    </tr>#}
{#                                {% endif %}#}
{#                            {% endfor %}#}
                            </tbody>
                            <thead>
                            <tr>

                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="box-footer clearfix">
                        <ul class="pagination pagination-sm no-margin pull-right">
                            <li class="prev disabled"><span>«</span></li>
                            <li class="active"><a href="/admin/user-admin/index?page=1&amp;per-page=50"
                                                  data-page="0">1</a></li>
                            <li><a href="/admin/user-admin/index?page=2&amp;per-page=50" data-page="1">2</a></li>
                            <li class="next"><a href="/admin/user-admin/index?page=2&amp;per-page=50"
                                                data-page="1">»</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    <div hidden class="empty-btn"><a class="btn btn-default btn-sm"
                                                                                 href="/admin/user-admin/invite/2"
                                                                                 title="Отправить приглашение"
                                                                                 data-toggle="tooltip"><i
                                                    class="fa fa-repeat"></i></a> <a class="btn btn-default btn-sm"
                                                                                     href="{% url 'update_user' user.pk %}"
                                                                                     title="Редактировать"
                                                                                     data-toggle="tooltip"><i
                                                    class="fa fa-pencil"></i></a> <a class="btn btn-default btn-sm"
                                                                                     href="/admin/user-admin/delete/2"
                                                                                     title="Удалить"
                                                                                     data-toggle="tooltip" data-pjax="0"
                                                                                     data-method="post"
                                                                                     data-confirm="Вы уверены, что хотите удалить этот элемент?"><i
                                                    class="fa fa-trash"></i></a></div>
    </div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript"
            src="{% static 'admin_panel/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script>
        $('#system_settings').attr('class', 'active treeview menu-open')
        $('#nav_users').attr('class', 'active')
    </script>
    <script>
    let numb = 0
    let colors = {
                'Активен': 'label label-success',
                'Отключен': 'label label-danger',
                'Новый': 'label label-warning',
            }
        let sort_data ={
            "name":'',
            "role":'',
            "phone":'',
            "username":'',
            "status":'',
        }
        let table
            function clear_filters() {
                $('.column_search').val('');
                sort_data ={
                "name":'',
                "role":'',
                "phone":'',
                "username":'',
                "status":'',
                }
                numb=0
                    table.draw()

            }

            function send_POST(e) {
                table = $('#users_table').DataTable({
                    serverSide: true,
                    processing: false,
                    oLanguage: {
                    sZeroRecords: "Ничего не найдено."
                    },
                    columnDefs: [
                        { targets: '_all', defaultContent:''},
                    ],
                    "ajax": {
                        "processing": true,
                        "url": "{% url 'user_list' %}",
                        "data": function (d) {
                            return sort_data;
                        },
                        "dataSrc": "",
                    },
                    "columns": [
                        {data: null,
                        render:function () {
                            numb++
                            return numb

                        }},
                        {"data": "name"},
                        {"data": "role__role"},
                        {"data": "phone"},
                        {"data": "username"},
                        {data: "status",
                            render: function (data, type) {
                        return `<small class="${colors[data]}">${data}</small>`;
                    },
                    },
                        {data: "id",
                            render:function (data, type) {
                            let link_update = '{% url 'update_user' 12345 %}'.replace(/12345/, data)
                            let link_delete = '{% url 'delete_user' 12345 %}'.replace(/12345/, data)
                                if (data === {{ admin.pk }}){
                                    return `<div class="btn-group pull-right"><a class="btn btn-default btn-sm" href="/admin/user-admin/invite/2" title="Отправить приглашение" data-toggle="tooltip"><i class="fa fa-repeat"></i></a> <a class="btn btn-default btn-sm" href="${link_update}" title="Редактировать" data-toggle="tooltip"><i class="fa fa-pencil"></i></a> <a class="btn btn-default btn-sm disabled" href="${link_delete}" title="Удалить" data-toggle="tooltip" data-pjax="0" id="delete_user" ><i class="fa fa-trash"></i></a></div>`
                                }
                                else {
                                    return `<div class="btn-group pull-right"><a class="btn btn-default btn-sm" href="/admin/user-admin/invite/2" title="Отправить приглашение" data-toggle="tooltip"><i class="fa fa-repeat"></i></a> <a class="btn btn-default btn-sm" href="${link_update}" title="Редактировать" data-toggle="tooltip"><i class="fa fa-pencil"></i></a> <a class="btn btn-default btn-sm" title="Удалить" data-toggle="tooltip" data-pjax="0" id="delete_user" onmousedown="return confirm_delete('${link_delete}',event);"> <i class="fa fa-trash"></i></a></div>`
                                }

                            },
                        }
                            ],
                    {#scrollCollapse: true,#}
                    paging: false,
                    {#scrollX: true,#}
                    searching: false,
                    ordering: false,
                    info: false,
                    {#pagingType: 'full_numbers',#}
                });
            }
            $('#users_table thead').on('change', ".column_search", function a (e) {
                sort_data[this.id] = $(this).val()
                numb=0
                table.draw()
            });



        $(document).ready(function () {
            send_POST();
            $('.column_search').val('');
        });
        function confirm_delete (link,event) {
            alertify.confirm('Подтверждение удаления', 'Удалить пользователя <b>'
                + $(event.target).closest( "tr " ).children().eq(1).text() + '</b> ?',
                function () {
                window.location.href = link
                },
                function () {
                }).set({labels: {ok: 'Подтвердить', cancel: 'Отмена'}});
                return false;
        }
        $('#users_table').on('click', 'tbody tr', function() {
            console.log(table.row(this).data().id)

        {#window.location.href = '{% url 'view_user' 12345 %}'.replace(/12345/, table.row(this).data().id)#}
})
    </script>

{% endblock %}